# reb -- Regular Expression Beautiful

reb 的目标是让信息抽取任务的正则更容易编写、维护，从而整个团队能写出规模更大的信息抽取模式。

和标准库里的 re 相比，reb 在这几方面作出改进: 

+ 可维护性 -- 用例子来辅助正则的编写和维护
+ 可重用性 -- 定义一次、多次使用
+ 易用性 -- 一次匹配提出多组同名片段

---

## 自然语言中的模式

自然语言中的模式是相对松散、不严格的；是基于数据集总结出来的，而不像那样 ip地址、url 有严格定义的标准格式。

为了涵盖多种表达方式，一个信息抽取任务考虑到五六种子模式是比较常见的。

## 引入例子

既然有五六种子模式，回看每个正则式时常常会很困惑，忘记了当初为什么要补充这个这个子模式。

正则不太直观，一眼看上去，不能想到哪些能匹配。

给复杂的正则式配上若干例子，有助于理解当初这个模式是怎么总结出来的。修改、维护也就更容易了。

## 用例子检测模式冲突

五六种子模式带来的另一个维护上的挑战是，模式之间有冲突。

假如代码库里现有的五个模式有 bad case，增加一个覆盖该 bad case 的新模式未必提升指标。因为以前匹配良好的情况遇到新模式反而出错，整体上拉低指标。

这种情况，就是新模式和现有模式发生了冲突。

糟糕的是，有些时候即使冲突发生，编写模式的人也未必知道。

通过引入例子，可以降低冲突发生的可能性。至少冲突发生时我们可以知道。

如果一个例子在单个子模式上的匹配结果和整体上不一样，说明有某些子模式互相冲突了。

维护模式的人可以相应调整这些模式，调整这些例子，化解这些冲突。

## 可以共用的模式

模式复杂了之后，有一个重要的诉求 -- 重用模式。

一个完整的匹配时间日期的正则式需要数十个字符。假设几个子模式中都出现时间日期，那么每次都必须重复这数十个字符。整个正则式会变得特别长，很难读。

理想的方式是，匹配日期的模式只写一次；用到它时，只要说明“这里要匹配一个日期”，模式会表达得简洁明了。

## 多个同名片段

re 支持给一个组命名，可以通过组名把该组对应的片段提取出来。这是一个非常有用的功能，比如匹配了日期之后，需要知道哪些字符对应年、哪些对应月。

但这个功能有一个限制，表达式中不能出现同名的组。假设匹配了一句话里面有多个“地点”，做不到把所有的“地点”片段都拿出来。

reb 尝试在以上方面做出改进。

---

### 一个对比

```python
# 从现病史中抽取医院 -- 传统 re 实现

import re

re.compile(r"""
  (?P<医院>当地医院)
  | 就[诊医]于?  (?P<医院>[^，。、]{3,12}[院心](?:附属.{3,10}[院心])?)   # 就诊于某医院
  | [到至在于往]
    (?:\d{2,4}[-.年,]\d{1,2}[-.月,]\d{1,2}日?)?
    (?P<医院>[^，。、]{3,12}[院心](?:附属.{3,10}[院心])?)
    就[诊医]?  # 在某年月日某医院就医
  | (?:\d{2,4}[-.年,]\d{1,2}[-.月,]\d{1,2}日?)?
    (?P<医院>[^，。、]{3,12}[院心](?:附属.{3,10}[院心])?)
      (?:胸部CT|PET(?:-CT)?|增强CT|胸部平扫|肠镜|穿刺|B超)[^，。、]{0,4}示  # 某年月日某医院某检查示
""", flags=re.VERBOSE)

```

```python
# 从现病史中抽取医院 -- reb 实现

from reb import P

# 数字
# ic for "In Chars"
num = P.ic('1234567890')

# 非标点
# nic for "Not In Chars"
nopunc = P.nic('，。、')

# 表示医院的模式
# n01 for "repeat N times 0 or 1"
# n for "repeat N times"
hosp = P.tag(
    P.n(nopunc, 3, 12) + P.ic('院心') + P.n01('附属' + P.n(P.ANYCHAR, 3, 10) + P.ic('院心')),
    tag='医院')

# 表示日期的模式
date = P.n(num, 2, 4) + P.ic('-,.年') + P.n(num, 1, 2) + P.ic('-,.月') + P.n01(P.n(num, 1, 2) + '日')

# 一些检查事件
# any for "matches if ANY sub pattern matches"
event = P.any('胸部CT', ('PET' + P.n01('-') + 'CT'), '增强CT', '胸部平扫', '肠镜', '穿刺', 'B超')

# 总结一些模式，从中提取医院
ptn = (
    P.example(
        P.tag('当地医院', tag='医院'),
            '...1周前当地医院复查提示...'
    )

    | P.example(
        ('就' + P.any('诊', '医') + P.n01('于') + hosp),
            '...无声嘶呛咳等不适，就诊于嘉兴市第一医院，2018-7-6查喉镜...',
      )

    | P.example(
        (P.ic('到至在于往') + P.n01(date) + hosp + '就' + P.ic('诊医')),
            '...2019.5出现左下肢水肿，6月于当地医院就诊，2019-07-29邵逸...',
            '...患者因“绝经后阴道流血1月余”于2019-4-16杭州市一医院就诊，行B超提示：...',
      )

    | P.example(
        (P.n01(date) + hosp + event + P.n(nopunc, 0, 4) + '示'),
            '...患者因“发现左侧腹股沟包块2月余”2014年12月3日台州医院B超示：左侧腹股沟多发肿大淋巴结...',
      )

)

```

